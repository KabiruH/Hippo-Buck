generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String          @unique
  password         String
  firstName        String
  lastName         String
  phone            String?
  role             String          @default("STAFF")
  isActive         Boolean         @default(true)
  lastLogin        DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  activities       ActivityLog[]
  bookingsCreated  Booking[]       @relation("BookingCreatedBy")
  bookingsModified Booking[]       @relation("BookingModifiedBy")
  passwordResets   PasswordReset[]
}

model RoomType {
  id              String            @id @default(cuid())
  name            String            @unique
  slug            String            @unique
  description     String            @db.NVarChar(Max)
  basePrice       Decimal           @db.Decimal(10, 2)
  maxOccupancy    Int
  bedType         String
  size            Float?
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  singlePriceEA   Decimal?          @db.Decimal(10, 2)
  doublePriceEA   Decimal?          @db.Decimal(10, 2)
  singlePriceIntl Decimal?          @db.Decimal(10, 2)
  doublePriceIntl Decimal?          @db.Decimal(10, 2)
  rooms           Room[]
  amenities       RoomAmenity[]
  images          RoomImage[]
  seasonalPricing SeasonalPricing[]
}

model RoomAmenity {
  id         String   @id @default(cuid())
  roomTypeId String
  amenity    String   @db.NVarChar(255)
  roomType   RoomType @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)

  @@index([roomTypeId])
}

model RoomImage {
  id           String   @id @default(cuid())
  roomTypeId   String
  imageUrl     String   @db.NVarChar(500)
  displayOrder Int      @default(0)
  isPrimary    Boolean  @default(false)
  roomType     RoomType @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)

  @@index([roomTypeId])
}

model Room {
  id              String           @id @default(cuid())
  roomNumber      String           @unique
  roomTypeId      String
  floor           Int
  status          String           @default("AVAILABLE")
  isActive        Boolean          @default(true)
  notes           String?          @db.NVarChar(Max)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookings        BookingRoom[]
  maintenanceLogs MaintenanceLog[]
  roomType        RoomType         @relation(fields: [roomTypeId], references: [id])
}

model Booking {
  id               String            @id @default(cuid())
  bookingNumber    String            @unique @default(cuid())
  guestFirstName   String
  guestLastName    String
  guestEmail       String
  guestPhone       String
  guestCountry     String?
  guestIdType      String?
  guestIdNumber    String?
  checkInDate      DateTime
  checkOutDate     DateTime
  numberOfAdults   Int
  numberOfChildren Int               @default(0)
  totalAmount      Decimal           @db.Decimal(10, 2)
  paidAmount       Decimal           @default(0) @db.Decimal(10, 2)
  status           String            @default("PENDING")
  paymentMethod    String?
  specialRequests  String?           @db.NVarChar(Max)
  actualCheckIn    DateTime?
  actualCheckOut   DateTime?
  createdById      String?
  modifiedById     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  cancelledAt      DateTime?
  mpesaCode        String?
  createdBy        User?             @relation("BookingCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  modifiedBy       User?             @relation("BookingModifiedBy", fields: [modifiedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rooms            BookingRoom[]
  services         BookingService[]
  customerHistory  CustomerHistory[]
  payments         Payment[]

  @@index([guestEmail])
  @@index([bookingNumber])
  @@index([checkInDate, checkOutDate])
  @@index([mpesaCode])
}

model BookingRoom {
  id             String  @id @default(cuid())
  bookingId      String
  roomId         String
  ratePerNight   Decimal @db.Decimal(10, 2)
  numberOfNights Int
  totalPrice     Decimal @db.Decimal(10, 2)
  booking        Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  room           Room    @relation(fields: [roomId], references: [id])

  @@unique([bookingId, roomId])
}

model Payment {
  id            String    @id @default(cuid())
  bookingId     String
  amount        Decimal   @db.Decimal(10, 2)
  paymentMethod String
  transactionId String?
  status        String    @default("PENDING")
  notes         String?
  processedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  booking       Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model Service {
  id              String           @id @default(cuid())
  name            String           @unique
  category        String
  price           Decimal          @db.Decimal(10, 2)
  description     String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookingServices BookingService[]
}

model BookingService {
  id          String   @id @default(cuid())
  bookingId   String
  serviceId   String
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  serviceDate DateTime @default(now())
  notes       String?
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [serviceId], references: [id])

  @@index([bookingId])
}

model SeasonalPricing {
  id              String   @id @default(cuid())
  roomTypeId      String
  seasonName      String
  startDate       DateTime
  endDate         DateTime
  priceMultiplier Float    @default(1.0)
  fixedPrice      Decimal? @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  roomType        RoomType @relation(fields: [roomTypeId], references: [id])

  @@index([startDate, endDate])
}

model MaintenanceLog {
  id             String    @id @default(cuid())
  roomId         String
  issue          String
  description    String?   @db.NVarChar(Max)
  status         String    @default("REPORTED")
  reportedBy     String?
  assignedTo     String?
  startDate      DateTime?
  completionDate DateTime?
  cost           Decimal?  @db.Decimal(10, 2)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  room           Room      @relation(fields: [roomId], references: [id])
}

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String?
  entityId   String?
  details    String?  @db.NVarChar(Max)
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model CustomerHistory {
  id             String   @id @default(cuid())
  bookingId      String
  guestFirstName String
  guestLastName  String
  guestEmail     String
  guestPhone     String
  checkInDate    DateTime
  checkOutDate   DateTime
  totalAmount    Decimal  @db.Decimal(10, 2)
  status         String
  notes          String?  @db.NVarChar(Max)
  recordedAt     DateTime @default(now())
  booking        Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([guestEmail])
  @@index([checkInDate])
}

model PaymentSummary {
  id                String   @id @default(cuid())
  date              DateTime @default(now())
  totalPayments     Decimal  @default(0) @db.Decimal(12, 2)
  completedPayments Decimal  @default(0) @db.Decimal(12, 2)
  pendingPayments   Decimal  @default(0) @db.Decimal(12, 2)
  refundedPayments  Decimal  @default(0) @db.Decimal(12, 2)
  numberOfBookings  Int      @default(0)
  updatedAt         DateTime @updatedAt
}
