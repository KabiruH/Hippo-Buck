generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// User model for staff and admin only (not customers)
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String    // hashed password
  firstName         String
  lastName          String
  phone             String?
  role              String    @default("STAFF") // "ADMIN", "MANAGER", "STAFF", "HOUSEKEEPING"
  isActive          Boolean   @default(true)
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  bookingsCreated   Booking[] @relation("BookingCreatedBy")
  bookingsModified  Booking[] @relation("BookingModifiedBy")
  activities        ActivityLog[]
  passwordResets    PasswordReset[]
}

// Room types/categories
model RoomType {
  id                String    @id @default(cuid())
  name              String    @unique
  slug              String    @unique
  description       String    @db.NVarChar(Max)
  basePrice         Decimal   @db.Decimal(10, 2)
  maxOccupancy      Int
  bedType           String
  size              Float?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  rooms             Room[]
  seasonalPricing   SeasonalPricing[]
  amenities         RoomAmenity[]
  images            RoomImage[]
}

// Separate table for amenities (SQL Server doesn't support arrays)
model RoomAmenity {
  id                String    @id @default(cuid())
  roomTypeId        String
  amenity           String    @db.NVarChar(255)
  
  roomType          RoomType  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  
  @@index([roomTypeId])
}

// Separate table for images (SQL Server doesn't support arrays)
model RoomImage {
  id                String    @id @default(cuid())
  roomTypeId        String
  imageUrl          String    @db.NVarChar(500)
  displayOrder      Int       @default(0)
  isPrimary         Boolean   @default(false)
  
  roomType          RoomType  @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)
  
  @@index([roomTypeId])
}

// Individual rooms
model Room {
  id                String    @id @default(cuid())
  roomNumber        String    @unique
  roomTypeId        String
  floor             Int
  status            String    @default("AVAILABLE") // "AVAILABLE", "OCCUPIED", "CLEANING", "MAINTENANCE", "RESERVED"
  isActive          Boolean   @default(true)
  notes             String?   @db.NVarChar(Max)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  roomType          RoomType  @relation(fields: [roomTypeId], references: [id])
  bookings          BookingRoom[]
  maintenanceLogs   MaintenanceLog[]
}

// Booking model (no customer account required)
model Booking {
  id                String    @id @default(cuid())
  bookingNumber     String    @unique @default(cuid())
  
  // Guest information
  guestFirstName    String
  guestLastName     String
  guestEmail        String
  guestPhone        String
  guestCountry      String?
  guestIdType       String?
  guestIdNumber     String?
  
  // Booking details
  checkInDate       DateTime
  checkOutDate      DateTime
  numberOfAdults    Int
  numberOfChildren  Int       @default(0)
  totalAmount       Decimal   @db.Decimal(10, 2)
  paidAmount        Decimal   @db.Decimal(10, 2) @default(0)
  status            String    @default("PENDING") // "PENDING", "CONFIRMED", "CHECKED_IN", "CHECKED_OUT", "CANCELLED", "NO_SHOW"
  paymentMethod     String?   // "CASH", "MPESA", "CREDIT_CARD", "DEBIT_CARD", "BANK_TRANSFER", "CHEQUE"
  specialRequests   String?   @db.NVarChar(Max)
  mpesaCode         String?
  
  // Check-in/out times
  actualCheckIn     DateTime?
  actualCheckOut    DateTime?
  
  // Staff tracking - NoAction to prevent cyclic cascade
  createdById       String?
  modifiedById      String?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cancelledAt       DateTime?
  
  // Relations
  createdBy         User?     @relation("BookingCreatedBy", fields: [createdById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  modifiedBy        User?     @relation("BookingModifiedBy", fields: [modifiedById], references: [id], onDelete: NoAction, onUpdate: NoAction)
  rooms             BookingRoom[]
  payments          Payment[]
  services          BookingService[]
  customerHistory   CustomerHistory[]
  
  @@index([guestEmail])
  @@index([bookingNumber])
  @@index([checkInDate, checkOutDate])
  @@index([mpesaCode])
}

// Many-to-many relation between bookings and rooms
model BookingRoom {
  id                String    @id @default(cuid())
  bookingId         String
  roomId            String
  ratePerNight      Decimal   @db.Decimal(10, 2)
  numberOfNights    Int
  totalPrice        Decimal   @db.Decimal(10, 2)
  
  // Relations
  booking           Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  room              Room      @relation(fields: [roomId], references: [id])
  
  @@unique([bookingId, roomId])
}

// Payment tracking
model Payment {
  id                String    @id @default(cuid())
  bookingId         String
  amount            Decimal   @db.Decimal(10, 2)
  paymentMethod     String    // "CASH", "MPESA", "CREDIT_CARD", "DEBIT_CARD", "BANK_TRANSFER", "CHEQUE"
  transactionId     String?
  status            String    @default("PENDING") // "PENDING", "COMPLETED", "FAILED", "REFUNDED", "PARTIAL"
  notes             String?
  processedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  booking           Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

// Additional services (restaurant, laundry, etc.)
model Service {
  id                String    @id @default(cuid())
  name              String    @unique
  category          String
  price             Decimal   @db.Decimal(10, 2)
  description       String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  bookingServices   BookingService[]
}

// Services added to bookings
model BookingService {
  id                String    @id @default(cuid())
  bookingId         String
  serviceId         String
  quantity          Int       @default(1)
  unitPrice         Decimal   @db.Decimal(10, 2)
  totalPrice        Decimal   @db.Decimal(10, 2)
  serviceDate       DateTime  @default(now())
  notes             String?
  
  // Relations
  booking           Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  service           Service   @relation(fields: [serviceId], references: [id])
  
  @@index([bookingId])
}

// Seasonal pricing
model SeasonalPricing {
  id                String    @id @default(cuid())
  roomTypeId        String
  seasonName        String
  startDate         DateTime
  endDate           DateTime
  priceMultiplier   Float     @default(1.0)
  fixedPrice        Decimal?  @db.Decimal(10, 2)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  roomType          RoomType  @relation(fields: [roomTypeId], references: [id])
  
  @@index([startDate, endDate])
}

// Room maintenance tracking
model MaintenanceLog {
  id                String    @id @default(cuid())
  roomId            String
  issue             String
  description       String?   @db.NVarChar(Max)
  status            String    @default("REPORTED") // "REPORTED", "IN_PROGRESS", "COMPLETED", "CANCELLED"
  reportedBy        String?
  assignedTo        String?
  startDate         DateTime?
  completionDate    DateTime?
  cost              Decimal?  @db.Decimal(10, 2)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  room              Room      @relation(fields: [roomId], references: [id])
}

// Activity logging for audit trail
model ActivityLog {
  id                String    @id @default(cuid())
  userId            String?
  action            String
  entityType        String?
  entityId          String?
  details           String?   @db.NVarChar(Max) // Store JSON as string
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime  @default(now())
  
  // Relations
  user              User?     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// Password reset tokens
model PasswordReset {
  id                String    @id @default(cuid())
  userId            String
  token             String    @unique
  expiresAt         DateTime
  usedAt            DateTime?
  createdAt         DateTime  @default(now())
  
  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
}

// Customer history tracking
model CustomerHistory {
  id               String     @id @default(cuid())
  bookingId        String
  guestFirstName   String
  guestLastName    String
  guestEmail       String
  guestPhone       String
  checkInDate      DateTime
  checkOutDate     DateTime
  totalAmount      Decimal    @db.Decimal(10, 2)
  status           String     // "PENDING", "CONFIRMED", "CHECKED_IN", "CHECKED_OUT", "CANCELLED", "NO_SHOW"
  notes            String?    @db.NVarChar(Max)
  recordedAt       DateTime   @default(now())

  // Relation
  booking          Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([guestEmail])
  @@index([checkInDate])
}

// Payment summary for reporting
model PaymentSummary {
  id                String     @id @default(cuid())
  date              DateTime   @default(now())
  totalPayments     Decimal    @db.Decimal(12, 2) @default(0)
  completedPayments Decimal    @db.Decimal(12, 2) @default(0)
  pendingPayments   Decimal    @db.Decimal(12, 2) @default(0)
  refundedPayments  Decimal    @db.Decimal(12, 2) @default(0)
  numberOfBookings  Int        @default(0)
  updatedAt         DateTime   @updatedAt
}
